package cn.edu.patent.lucene;

import java.io.IOException;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.cn.smart.SmartChineseAnalyzer;
import org.apache.lucene.document.Document;
import org.apache.lucene.index.DirectoryReader;
import org.apache.lucene.index.IndexReader;
import org.apache.lucene.index.Term;
import org.apache.lucene.queryparser.classic.MultiFieldQueryParser;
import org.apache.lucene.queryparser.classic.ParseException;
import org.apache.lucene.search.BooleanClause;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.ScoreDoc;
import org.apache.lucene.search.TermQuery;
import org.apache.lucene.search.TopDocs;
import org.apache.lucene.search.highlight.SimpleHTMLFormatter;
import org.apache.lucene.store.Directory;
import org.apache.lucene.store.FSDirectory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.mysql.cj.xdevapi.JsonArray;

import cn.edu.patent.dao.jkeep3.patentKeep;
import cn.edu.patent.pojo.patent;
import cn.edu.patent.util.ApplcationUtil;

/**
 * @author:JXH
 * @date:2019å¹´4æœˆ5æ—¥-ä¸‹åˆ6:14:32
 * æœç´¢!
 */
@Component
public class searchIndex extends luceneUtil{
	
	
	/*
	 * private String[] fields1= {"createThing", "requestNumber",
	 * "publicatioNumber", "ipc", "createPeople", "filingDate", "publicationDate",
	 * "proposer", "priorityNumber", "remark", "profitRequest", "technicalField",
	 * "BackgroundTechnology", "summaryInvention", "practicalContent",
	 * "descriptionDrawings", "specificMethods"
	 * 
	 * };
	 */
	
	
	//@Autowired(required=false)
	//@Qualifier("IndexSearcher")
	private IndexSearcher searcher;
	 /**
	   * æœç´¢,ä¸èƒ½äº¤ç»™springç®¡ç†,å¦åˆ™å½“æˆ‘åˆ é™¤ä¸€ä¸ªå,è¿˜èƒ½è¢«æœåˆ°,!æ¯æ¬¡æŸ¥è¯¢,newä¸€ä¸ª
	   * @return
	   * @throws IOException
	   */
	  public IndexSearcher IndexSearcher() throws IOException {
		  Directory directory=FSDirectory.open(Paths.get(indexpackage));
		  IndexReader reader=DirectoryReader.open(directory);
		  IndexSearcher searcher=new IndexSearcher(reader);
		  return searcher;
	  }
	/**
	 * æ³¨å…¥ä¸­æ–‡åˆ†è¯å™¨
	 */
	@Autowired
	@Qualifier("SmartChineseAnalyzer")
	private Analyzer SmartChineseAnalyzer;
	public JSONObject search(String query,int pageNow,int pageSize) throws IOException, ParseException {
		searcher=IndexSearcher();
		//ArrayList<String> patents=new ArrayList<String>();
		JSONObject result=new JSONObject();
		JSONArray patents=new JSONArray();
		 /*å¤šå­—æ®µæŸ¥è¯¢
		 * è¡¨ç¤ºå¤šä¸ªæ¡ä»¶ä¹‹é—´çš„å…³ç³»ï¼
		 * BooleanClause.Occur.SHOULD or
		 * BooleanClause.Occur.MUST   and
		 * BooleanClause.Occur.MUST_NOT not
		 */
	    BooleanClause.Occur[] occur=new BooleanClause.Occur[fields.length];
	    Arrays.fill(occur, BooleanClause.Occur.SHOULD);
		Query seQuery=MultiFieldQueryParser.parse(query,fields,occur, SmartChineseAnalyzer);
	//	Query seQuery=new TermQuery(new Term("createThing", query)); å•åŸŸæŸ¥è¯¢ï¼
		//TopDocs topDocs=searcher.search(seQuery,pageSize); ä¸€æ¬¡æ˜¾ç¤ºå¤šå°‘æ¡
		//åˆ†é¡µæŸ¥è¯¢
		int start=(pageNow-1)*pageSize;
		//è·å–ä¸Šä¸€é¡µæœ€åä¸€ä¸ªå…ƒç´ 
		ScoreDoc preDoc=null;
		if (start>0) {
			TopDocs lasTopDocs=searcher.search(seQuery,start);
			preDoc=lasTopDocs.scoreDocs[start-1];
		}
		TopDocs topDocs=searcher.searchAfter(preDoc, seQuery, pageSize);
		 int totalcount= topDocs.totalHits;
		//åˆ†é¡µæŸ¥è¯¢
		ScoreDoc[] hDocs= topDocs.scoreDocs;
		for(ScoreDoc scoreDoc:hDocs) {
			 Document document=searcher.doc(scoreDoc.doc);
			// patent patent=new patent();
			 //ä¸“åˆ©id
			// patent.setId(Integer.parseInt(document.get("id")));
			 //ä¸“åˆ©åç§°
			// patent.setCreateThing(document.get("createThing"));
			 //ä¸“åˆ©ç”³è¯·å·
			// patent.setRequestNumber(document.get("requestNumber"));
			 //ipcåˆ†ç±»å·
			// patent.setIpc(document.get("ipc"));
			 //ç”³è¯·äºº
			// patent.setProposer(document.get("proposer"));
			 //ç”³è¯·æ—¥
			// patent.setFilingDate(document.get("filingDate"));
			 //æ‘˜è¦
			// patent.setRemark(Arrays.asList(document.get("remark").split("$")));
			 //åŠ å…¥ç»“æœ
			// patents.add(patent);
			 
			 String div="<div class='patent-div' patent-id="+document.get("id")+" style='font-size:13px;'>\n" + 
			 		"<p class='patent-title'>\n" + 
			 		"<span style='margin-left:2px;margin-right:2px;'>ğŸ“Œ[å‘æ˜]</span>\n" + 
			 		"<span style='font-size:16px;'>"+document.get("createThing")+"</sapn>-<span>ç”³è¯·å·:</span><span>"+document.get("requestNumber")+"</span>\n" + 
			 		"</p>\n" + 
			 		"<p style='color:#31708f;font-size:12px''>\n" + 
			 		"<span>ğŸ‘¤ç”³è¯·äººï¼š</span><span>"+document.get("proposer")+"<span>-\n" + 
			 		"<span>ğŸ“…ç”³è¯·æ—¥ï¼š</span><span>"+document.get("filingDate")+"<span>-\n" + 
			 		"<span>ğŸ—„ï¸ä¸»åˆ†ç±»å·ï¼š</span><span>"+document.get("ipc")+"<span>-\n" + 
			 		"</p>\n" + 
			 		"<p>\n" + 
			 		"<span>ğŸ“œæ‘˜è¦:</span><sapn>"+Arrays.asList(document.get("remark").split("$"))+"</sapn>\n" + 
			 		"</p>\n" + 
			 		"</div>";
			 //è‡ªå®šä¹‰é«˜äº®
			 div=div.replace(query,"<span style='color:#a94442;'>"+query+"</span>");
			 JSONObject divObject=new JSONObject();
			 divObject.put("div", div);
			 patents.add(divObject);
		 }
		result.put("count", totalcount);//æ€»è®°å½•æ•°
		result.put("data", patents);
		searcher=null;
		return result;
	}
	
}
